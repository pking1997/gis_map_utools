<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>坐标系转换（增强版）· GIS Map UTools</title>
  <link rel="stylesheet" href="assets/css/styles.css"/>
  <style>
    .wrap{max-width:1400px;margin:0 auto;padding:20px}
    .card{border:1px solid #202637;border-radius:12px;padding:20px;background:linear-gradient(180deg,#0e121a,#0b0d12);margin-bottom:20px}
    .row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px}
    .col{flex:1 1 300px}
    .col-wide{flex:1 1 600px}
    label{display:block;margin-bottom:8px;color:#9aa4b2;font-weight:500}
    input,select,textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #202637;background:#0e1117;color:#e6eaf2;outline:none;font-family:monospace}
    textarea{min-height:320px;resize:vertical}
    .btn{display:inline-block;background:#3b82f6;color:#fff;border:none;border-radius:8px;padding:12px 20px;cursor:pointer;margin-right:12px;margin-bottom:8px}
    .btn.secondary{background:#374151}
    .btn.success{background:#059669}
    .btn.info{background:#0ea5e9}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#9aa4b2;font-size:14px}
    .mt{margin-top:16px}
    .mb{margin-bottom:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px}
    .small{font-size:13px}
    .format-tabs{display:flex;gap:8px;margin-bottom:16px}
    .format-tab{background:#1f2937;border:1px solid #374151;color:#9ca3af;padding:8px 16px;border-radius:6px;cursor:pointer;transition:all 0.2s}
    .format-tab.active{background:#3b82f6;border-color:#3b82f6;color:#fff}
    .format-tab:hover{background:#374151}
    .status{background:#1f2937;border:1px solid #374151;border-radius:8px;padding:12px;margin-top:16px}
    .status.success{border-color:#059669;background:#064e3b}
    .status.error{border-color:#dc2626;background:#7f1d1d}
    .status.info{border-color:#3b82f6;background:#1e3a8a}
    
    /* 优化的左右布局 */
    .converter-layout{display:flex;gap:24px;align-items:flex-start;margin-top:20px}
    .converter-panel{flex:1;display:flex;flex-direction:column}
    .converter-controls{display:flex;flex-direction:column;gap:16px;justify-content:center;align-items:center;padding:40px 0;min-height:320px}
    .convert-btn{width:60px;height:60px;border-radius:50%;font-size:32px;margin:8px 0;border:none;background:transparent;color:#3b82f6;transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;line-height:1;font-weight:bold;cursor:pointer}
    .convert-btn:hover{transform:scale(1.1);color:#1d4ed8}
    .convert-btn:active{transform:scale(0.95)}
    .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .panel-actions{display:flex;gap:8px;align-items:center}
    .panel-actions .btn{padding:8px 12px;font-size:12px;margin:0}
    .crs-selector{display:flex;gap:8px;align-items:center}
    .crs-selector select{flex:1;max-width:120px;padding:6px 8px;font-size:12px;border-radius:6px}
    .crs-label{color:#9aa4b2;font-size:12px;white-space:nowrap}
    
    @media (prefers-color-scheme: light){
      .card{background:linear-gradient(180deg,#fff,#f9fafb);border-color:#e5e7eb}
      input,select,textarea{background:#fff;border-color:#e5e7eb;color:#0f172a}
      .format-tab{background:#f3f4f6;border-color:#d1d5db;color:#374151}
      .format-tab.active{background:#3b82f6;border-color:#3b82f6;color:#fff}
      .format-tab:hover{background:#e5e7eb}
      .status{background:#f9fafb;border-color:#e5e7eb}
      .convert-btn{border-color:#d1d5db;background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>坐标系转换（增强版）</h1>
    <p class="muted">支持 WKT、GeoJSON 格式的批量坐标系转换。在 BD-09、GCJ-02、WGS84 之间进行互转。</p>

    <div class="card">
      <h3>坐标系转换</h3>
      <div class="format-tabs">
        <div class="format-tab active" data-format="wkt">WKT 格式</div>
        <div class="format-tab" data-format="geojson">GeoJSON 格式</div>
        <div class="format-tab" data-format="lnglat">经纬度数组</div>
      </div>
      
      <div class="converter-layout">
        <!-- 左侧输入 -->
        <div class="converter-panel">
          <div class="panel-header">
            <div class="crs-selector">
              <span class="crs-label">坐标系：</span>
              <select id="left-crs">
                <option value="bd09">BD-09（百度）</option>
                <option value="gcj02">GCJ-02（国测局）</option>
                <option value="wgs84">WGS84（GPS）</option>
              </select>
            </div>
            <div class="panel-actions">
              <button class="btn info" id="sample-left">示例</button>
              <button class="btn secondary" id="clear-left">清空</button>
              <button class="btn secondary" id="copy-left">复制</button>
            </div>
          </div>
          <textarea id="left-input" placeholder="在此输入要转换的数据..."></textarea>
        </div>
        
        <!-- 中间控制按钮 -->
        <div class="converter-controls">
          <button class="convert-btn" id="left-to-right" title="左转右">➜</button>
          <button class="convert-btn" id="right-to-left" title="右转左" style="transform: rotate(180deg);">➜</button>
        </div>
        
        <!-- 右侧输入 -->
        <div class="converter-panel">
          <div class="panel-header">
            <div class="crs-selector">
              <span class="crs-label">坐标系：</span>
              <select id="right-crs">
                <option value="gcj02">GCJ-02（国测局）</option>
                <option value="bd09">BD-09（百度）</option>
                <option value="wgs84">WGS84（GPS）</option>
              </select>
            </div>
            <div class="panel-actions">
              <button class="btn info" id="sample-right">示例</button>
              <button class="btn secondary" id="clear-right">清空</button>
              <button class="btn success" id="copy-right">复制</button>
            </div>
          </div>
          <textarea id="right-input" placeholder="在此输入要转换的数据..."></textarea>
        </div>
      </div>
      
      <div id="status" class="status info mt">
        <div>等待转换...</div>
      </div>
    </div>

    <div class="card">
      <h3>使用说明</h3>
      <div class="grid">
        <div>
          <h4>WKT 格式</h4>
          <p class="small muted">支持标准的 WKT 格式，包括：</p>
          <ul class="small muted">
            <li>POINT(x y)</li>
            <li>LINESTRING(x1 y1, x2 y2, ...)</li>
            <li>POLYGON((x1 y1, x2 y2, ..., x1 y1))</li>
            <li>MULTIPOINT、MULTILINESTRING、MULTIPOLYGON</li>
          </ul>
        </div>
        <div>
          <h4>GeoJSON 格式</h4>
          <p class="small muted">支持标准的 GeoJSON 格式：</p>
          <ul class="small muted">
            <li>Feature</li>
            <li>FeatureCollection</li>
            <li>Geometry 对象</li>
          </ul>
        </div>
        <div>
          <h4>坐标系说明</h4>
          <p class="small muted">坐标系转换说明：</p>
          <ul class="small muted">
            <li>BD-09：百度坐标系</li>
            <li>GCJ-02：国测局火星坐标系</li>
            <li>WGS84：GPS 原始坐标系</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/js/layout.js"></script>
  <script>
  (function(){
    // 坐标转换算法
    var PI = Math.PI;
    var AXIS = 6378245.0;
    var EE = 0.00669342162296594323;

    function outOfChina(lon, lat){
      return lon < 72.004 || lon > 137.8347 || lat < 0.8293 || lat > 55.8271;
    }
    
    function transformLat(x, y){
      var ret = -100.0 + 2.0*x + 3.0*y + 0.2*y*y + 0.1*x*y + 0.2*Math.sqrt(Math.abs(x));
      ret += (20.0*Math.sin(6.0*x*PI) + 20.0*Math.sin(2.0*x*PI))*2.0/3.0;
      ret += (20.0*Math.sin(y*PI) + 40.0*Math.sin(y/3.0*PI))*2.0/3.0;
      ret += (160.0*Math.sin(y/12.0*PI) + 320*Math.sin(y*PI/30.0))*2.0/3.0;
      return ret;
    }
    
    function transformLon(x, y){
      var ret = 300.0 + x + 2.0*y + 0.1*x*x + 0.1*x*y + 0.1*Math.sqrt(Math.abs(x));
      ret += (20.0*Math.sin(6.0*x*PI) + 20.0*Math.sin(2.0*x*PI))*2.0/3.0;
      ret += (20.0*Math.sin(x*PI) + 40.0*Math.sin(x/3.0*PI))*2.0/3.0;
      ret += (150.0*Math.sin(x/12.0*PI) + 300.0*Math.sin(x/30.0*PI))*2.0/3.0;
      return ret;
    }
    
    function delta(lon, lat){
      var dLat = transformLat(lon-105.0, lat-35.0);
      var dLon = transformLon(lon-105.0, lat-35.0);
      var radLat = lat/180.0*PI;
      var magic = Math.sin(radLat);
      magic = 1 - EE*magic*magic;
      var sqrtMagic = Math.sqrt(magic);
      dLat = (dLat*180.0)/((AXIS*(1-EE))/(magic*sqrtMagic)*PI);
      dLon = (dLon*180.0)/(AXIS/ sqrtMagic * Math.cos(radLat)*PI);
      return {lon:dLon, lat:dLat};
    }
    
    function wgs84ToGcj02(lon, lat){
      if(outOfChina(lon, lat)) return {lon:lon, lat:lat};
      var d = delta(lon,lat);
      return {lon: lon + d.lon, lat: lat + d.lat};
    }
    
    function gcj02ToWgs84(lon, lat){
      if(outOfChina(lon, lat)) return {lon:lon, lat:lat};
      var d = delta(lon,lat);
      return {lon: lon - d.lon, lat: lat - d.lat};
    }
    
    function gcj02ToBd09(lon, lat){
      var z = Math.sqrt(lon*lon + lat*lat) + 0.00002*Math.sin(lat*PI);
      var theta = Math.atan2(lat, lon) + 0.000003*Math.cos(lon*PI);
      return {lon: z*Math.cos(theta) + 0.0065, lat: z*Math.sin(theta) + 0.006};
    }
    
    function bd09ToGcj02(lon, lat){
      var x = lon - 0.0065;
      var y = lat - 0.006;
      var z = Math.sqrt(x*x + y*y) - 0.00002*Math.sin(y*PI);
      var theta = Math.atan2(y, x) - 0.000003*Math.cos(x*PI);
      return {lon: z*Math.cos(theta), lat: z*Math.sin(theta)};
    }
    
    function wgs84ToBd09(lon, lat){
      var g = wgs84ToGcj02(lon,lat); return gcj02ToBd09(g.lon,g.lat);
    }
    
    function bd09ToWgs84(lon, lat){
      var g = bd09ToGcj02(lon,lat); return gcj02ToWgs84(g.lon,g.lat);
    }

    function convert(from, to, lon, lat){
      if(from===to) return {lon:lon, lat:lat};
      if(from==='wgs84'&&to==='gcj02') return wgs84ToGcj02(lon,lat);
      if(from==='gcj02'&&to==='wgs84') return gcj02ToWgs84(lon,lat);
      if(from==='gcj02'&&to==='bd09') return gcj02ToBd09(lon,lat);
      if(from==='bd09'&&to==='gcj02') return bd09ToGcj02(lon,lat);
      if(from==='wgs84'&&to==='bd09') return wgs84ToBd09(lon,lat);
      if(from==='bd09'&&to==='wgs84') return bd09ToWgs84(lon,lat);
      return {lon:lon, lat:lat};
    }

    // WKT 解析和生成
    function parseWKT(wkt) {
      try {
        var parts = wkt.match(/^(\w+)\s*\((.*)\)$/);
        if (!parts) return null;
        
        var type = parts[1].toUpperCase();
        var coords = parts[2];
        
        if (type === 'POINT') {
          var point = coords.trim().split(/\s+/);
          return {
            type: 'Point',
            coordinates: [parseFloat(point[0]), parseFloat(point[1])]
          };
        } else if (type === 'LINESTRING') {
          var points = coords.split(',').map(function(p) {
            var xy = p.trim().split(/\s+/);
            return [parseFloat(xy[0]), parseFloat(xy[1])];
          });
          return {
            type: 'LineString',
            coordinates: points
          };
        } else if (type === 'POLYGON') {
          var rings = coords.split('),(').map(function(ring) {
            ring = ring.replace(/[()]/g, '');
            var points = ring.split(',').map(function(p) {
              var xy = p.trim().split(/\s+/);
              return [parseFloat(xy[0]), parseFloat(xy[1])];
            });
            return points;
          });
          return {
            type: 'Polygon',
            coordinates: rings
          };
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    function generateWKT(geometry) {
      if (geometry.type === 'Point') {
        return 'POINT(' + geometry.coordinates[0] + ' ' + geometry.coordinates[1] + ')';
      } else if (geometry.type === 'LineString') {
        var coords = geometry.coordinates.map(function(p) {
          return p[0] + ' ' + p[1];
        }).join(', ');
        return 'LINESTRING(' + coords + ')';
      } else if (geometry.type === 'Polygon') {
        var rings = geometry.coordinates.map(function(ring) {
          var coords = ring.map(function(p) {
            return p[0] + ' ' + p[1];
          }).join(', ');
          return '(' + coords + ')';
        }).join(', ');
        return 'POLYGON(' + rings + ')';
      }
      return '';
    }

    // 坐标转换核心函数
    function transformCoordinates(coords, from, to) {
      if (Array.isArray(coords[0])) {
        return coords.map(function(coord) {
          return transformCoordinates(coord, from, to);
        });
      } else {
        var result = convert(from, to, coords[0], coords[1]);
        return [result.lon, result.lat];
      }
    }

    function transformGeometry(geometry, from, to) {
      var newGeometry = JSON.parse(JSON.stringify(geometry));
      newGeometry.coordinates = transformCoordinates(geometry.coordinates, from, to);
      return newGeometry;
    }

    // 示例数据
    var sampleData = {
      wkt: 'POINT(116.397128 39.916527)\nLINESTRING(116.397128 39.916527, 121.473701 31.230416)',
      geojson: '{\n  "type": "Feature",\n  "geometry": {\n    "type": "Point",\n    "coordinates": [116.397128, 39.916527]\n  }\n}',
      lnglat: '116.397128,39.916527\n121.473701,31.230416'
    };

    // UI 逻辑
    var $ = function(id){ return document.getElementById(id); };
    var leftInput = $('left-input');
    var rightInput = $('right-input');
    var status = $('status');
    var currentFormat = 'wkt';

    // 格式切换
    var formatTabs = document.querySelectorAll('.format-tab');
    formatTabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        currentFormat = this.dataset.format;
        formatTabs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // 更新占位符
        if (currentFormat === 'wkt') {
          leftInput.placeholder = '示例：\nPOINT(116.397128 39.916527)\nLINESTRING(116.397128 39.916527, 121.473701 31.230416)';
          rightInput.placeholder = '转换结果将显示在这里...';
        } else if (currentFormat === 'geojson') {
          leftInput.placeholder = '示例：\n{\n  "type": "Feature",\n  "geometry": {\n    "type": "Point",\n    "coordinates": [116.397128, 39.916527]\n  }\n}';
          rightInput.placeholder = '转换结果将显示在这里...';
        } else if (currentFormat === 'lnglat') {
          leftInput.placeholder = '示例：\n116.397128,39.916527\n121.473701,31.230416';
          rightInput.placeholder = '转换结果将显示在这里...';
        }
      });
    });

    // 文本清理函数
    function cleanInputText(input) {
      return input
        .replace(/\r\n/g, '\n')  // 统一换行符
        .replace(/\r/g, '\n')    // 处理回车符
        .replace(/\n\s+/g, '\n') // 移除行首空格
        .replace(/\s+\n/g, '\n') // 移除行尾空格
        .replace(/\n{3,}/g, '\n\n') // 最多保留两个连续换行
        .trim(); // 移除首尾空白
    }

    function convertData(fromCrs, toCrs, input) {
      // 清理输入文本
      var cleanedInput = cleanInputText(input);
      
      if (!cleanedInput) {
        showStatus('请输入要转换的数据', 'error');
        return '';
      }

      try {
        var result = '';
        var count = 0;
        
        if (currentFormat === 'wkt') {
          var geometry = parseWKT(cleanedInput);
          if (!geometry) {
            showStatus('WKT 格式解析失败，请检查格式是否正确', 'error');
            return '';
          }
          var transformed = transformGeometry(geometry, fromCrs, toCrs);
          result = generateWKT(transformed);
          count = 1;
        } else if (currentFormat === 'geojson') {
          var geojson = JSON.parse(cleanedInput);
          if (geojson.type === 'Feature') {
            var transformed = transformGeometry(geojson.geometry, fromCrs, toCrs);
            geojson.geometry = transformed;
            result = JSON.stringify(geojson, null, 2);
            count = 1;
          } else if (geojson.type === 'FeatureCollection') {
            geojson.features.forEach(function(feature) {
              feature.geometry = transformGeometry(feature.geometry, fromCrs, toCrs);
            });
            result = JSON.stringify(geojson, null, 2);
            count = geojson.features.length;
          } else {
            var transformed = transformGeometry(geojson, fromCrs, toCrs);
            result = JSON.stringify(transformed, null, 2);
            count = 1;
          }
        } else if (currentFormat === 'lnglat') {
          var lines = cleanedInput.split('\n');
          var results = [];
          for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();
            if (!line) continue;
            var coords = line.split(/[,\s]+/);
            if (coords.length >= 2) {
              var lon = parseFloat(coords[0]);
              var lat = parseFloat(coords[1]);
              if (!isNaN(lon) && !isNaN(lat)) {
                var result = convert(fromCrs, toCrs, lon, lat);
                results.push(result.lon.toFixed(6) + ',' + result.lat.toFixed(6));
                count++;
              }
            }
          }
          result = results.join('\n');
        }
        
        showStatus('转换完成！共处理 ' + count + ' 个坐标点', 'success');
        return result;
        
      } catch (e) {
        showStatus('转换失败：' + e.message, 'error');
        return '';
      }
    }

    function showStatus(message, type) {
      status.className = 'status ' + type;
      status.innerHTML = '<div>' + message + '</div>';
    }

    function copyText(text) {
      if (text) {
        navigator.clipboard.writeText(text).then(function() {
          showStatus('已复制到剪贴板', 'success');
        }).catch(function() {
          showStatus('复制失败，请手动选择复制', 'error');
        });
      }
    }

    function loadSampleData(target) {
      target.value = sampleData[currentFormat];
      showStatus('已加载示例数据', 'info');
    }

    // 事件绑定
    $('left-to-right').addEventListener('click', function() {
      var fromCrs = $('left-crs').value;
      var toCrs = $('right-crs').value;
      var result = convertData(fromCrs, toCrs, leftInput.value);
      if (result) rightInput.value = result;
    });

    $('right-to-left').addEventListener('click', function() {
      var fromCrs = $('right-crs').value;
      var toCrs = $('left-crs').value;
      var result = convertData(fromCrs, toCrs, rightInput.value);
      if (result) leftInput.value = result;
    });

    $('clear-left').addEventListener('click', function() {
      leftInput.value = '';
    });

    $('clear-right').addEventListener('click', function() {
      rightInput.value = '';
    });

    $('copy-left').addEventListener('click', function() {
      copyText(leftInput.value);
    });

    $('copy-right').addEventListener('click', function() {
      copyText(rightInput.value);
    });

    $('sample-left').addEventListener('click', function() {
      loadSampleData(leftInput);
    });

    $('sample-right').addEventListener('click', function() {
      loadSampleData(rightInput);
    });

    // 初始化
    showStatus('等待转换...', 'info');
  })();
  </script>
</body>
</html>
