<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>围栏数据转换 · GIS Map UTools</title>
  <link rel="stylesheet" href="assets/css/styles.css"/>
  <style>
    .wrap{max-width:1400px;margin:0 auto;padding:20px}
    .card{border:1px solid #202637;border-radius:12px;padding:20px;background:linear-gradient(180deg,#0e121a,#0b0d12);margin-bottom:20px}
    .row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px}
    .col{flex:1 1 300px}
    .col-wide{flex:1 1 600px}
    label{display:block;margin-bottom:8px;color:#9aa4b2;font-weight:500}
    input,select,textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #202637;background:#0e1117;color:#e6eaf2;outline:none;font-family:monospace}
    textarea{min-height:320px;resize:vertical}
    .btn{display:inline-block;background:#3b82f6;color:#fff;border:none;border-radius:8px;padding:12px 20px;cursor:pointer;margin-right:12px;margin-bottom:8px}
    .btn.secondary{background:#374151}
    .btn.success{background:#059669}
    .btn.info{background:#0ea5e9}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#9aa4b2;font-size:14px}
    .mt{margin-top:16px}
    .mb{margin-bottom:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px}
    .small{font-size:13px}
    .format-tabs{display:flex;gap:8px;margin-bottom:16px}
    .format-tab{background:#1f2937;border:1px solid #374151;color:#9ca3af;padding:8px 16px;border-radius:6px;cursor:pointer;transition:all 0.2s}
    .format-tab.active{background:#3b82f6;border-color:#3b82f6;color:#fff}
    .format-tab:hover{background:#374151}
    .status{background:#1f2937;border:1px solid #374151;border-radius:8px;padding:12px;margin-top:16px}
    .status.success{border-color:#059669;background:#064e3b}
    .status.error{border-color:#dc2626;background:#7f1d1d}
    .status.info{border-color:#3b82f6;background:#1e3a8a}
    
    /* 优化的左右布局 */
    .converter-layout{display:flex;gap:24px;align-items:flex-start;margin-top:20px}
    .converter-panel{flex:1;display:flex;flex-direction:column}
    .converter-controls{display:flex;flex-direction:column;gap:16px;justify-content:center;align-items:center;padding:40px 0;min-height:320px}
    .convert-btn{width:60px;height:60px;border-radius:50%;font-size:32px;margin:8px 0;border:none;background:transparent;color:#3b82f6;transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;line-height:1;font-weight:bold;cursor:pointer}
    .convert-btn:hover{transform:scale(1.1);color:#1d4ed8}
    .convert-btn:active{transform:scale(0.95)}
    .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .panel-actions{display:flex;gap:8px;align-items:center}
    .panel-actions .btn{padding:8px 12px;font-size:12px;margin:0}
    
    @media (prefers-color-scheme: light){
      .card{background:linear-gradient(180deg,#fff,#f9fafb);border-color:#e5e7eb}
      input,select,textarea{background:#fff;border-color:#e5e7eb;color:#0f172a}
      .format-tab{background:#f3f4f6;border-color:#d1d5db;color:#374151}
      .format-tab.active{background:#3b82f6;border-color:#3b82f6;color:#fff}
      .format-tab:hover{background:#e5e7eb}
      .status{background:#f9fafb;border-color:#e5e7eb}
      .convert-btn{border-color:#d1d5db;background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>围栏数据转换</h1>
    <p class="muted">支持 lnglat 对象数组、WKT、GeoJSON 之间的格式转换。快速处理各种围栏数据格式。</p>

    <div class="card">
      <h3>数据转换</h3>
      <div class="format-tabs">
        <div class="format-tab active" data-format="lnglat">经纬度数组</div>
        <div class="format-tab" data-format="wkt">WKT 格式</div>
        <div class="format-tab" data-format="geojson">GeoJSON 格式</div>
      </div>
      
      <div class="converter-layout">
        <!-- 左侧输入 -->
        <div class="converter-panel">
          <div class="panel-header">
            <div></div>
            <div class="panel-actions">
              <button class="btn info" id="sample-left">示例</button>
              <button class="btn secondary" id="clear-left">清空</button>
              <button class="btn secondary" id="copy-left">复制</button>
            </div>
          </div>
          <textarea id="left-input" placeholder="在此输入要转换的数据..."></textarea>
        </div>
        
        <!-- 中间控制按钮 -->
        <div class="converter-controls">
          <button class="convert-btn" id="left-to-right" title="左转右">➜</button>
          <button class="convert-btn" id="right-to-left" title="右转左" style="transform: rotate(180deg);">➜</button>
        </div>
        
        <!-- 右侧输入 -->
        <div class="converter-panel">
          <div class="panel-header">
            <div></div>
            <div class="panel-actions">
              <button class="btn info" id="sample-right">示例</button>
              <button class="btn secondary" id="clear-right">清空</button>
              <button class="btn success" id="copy-right">复制</button>
            </div>
          </div>
          <textarea id="right-input" placeholder="在此输入要转换的数据..."></textarea>
        </div>
      </div>
      
      <div id="status" class="status info mt">
        <div>等待转换...</div>
      </div>
    </div>

    <div class="card">
      <h3>使用说明</h3>
      <div class="grid">
        <div>
          <h4>经纬度数组格式</h4>
          <p class="small muted">支持多种输入格式：</p>
          <ul class="small muted">
            <li>对象数组：[{lng: 116.397, lat: 39.916}, ...]</li>
            <li>数组格式：[[116.397, 39.916], ...]</li>
            <li>逗号分隔：116.397,39.916;121.473,31.230</li>
            <li>换行分隔：每行一组坐标</li>
          </ul>
        </div>
        <div>
          <h4>WKT 格式</h4>
          <p class="small muted">支持标准的 WKT 格式：</p>
          <ul class="small muted">
            <li>POINT(x y)</li>
            <li>LINESTRING(x1 y1, x2 y2, ...)</li>
            <li>POLYGON((x1 y1, x2 y2, ..., x1 y1))</li>
            <li>MULTIPOINT、MULTILINESTRING、MULTIPOLYGON</li>
          </ul>
        </div>
        <div>
          <h4>GeoJSON 格式</h4>
          <p class="small muted">支持标准的 GeoJSON 格式：</p>
          <ul class="small muted">
            <li>Feature</li>
            <li>FeatureCollection</li>
            <li>Geometry 对象</li>
            <li>自动识别几何类型</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/js/layout.js"></script>
  <script>
  (function(){
    // UI 逻辑
    var $ = function(id){ return document.getElementById(id); };
    var leftInput = $('left-input');
    var rightInput = $('right-input');
    var status = $('status');
    var currentFormat = 'lnglat';

    // 示例数据
    var sampleData = {
      lnglat: '[{lng: 116.397, lat: 39.916}, {lng: 121.473, lat: 31.230}]\n[[116.397, 39.916], [121.473, 31.230]]\n116.397,39.916;121.473,31.230',
      wkt: 'POINT(116.397128 39.916527)\nLINESTRING(116.397128 39.916527, 121.473701 31.230416)',
      geojson: '{\n  "type": "Feature",\n  "geometry": {\n    "type": "Point",\n    "coordinates": [116.397128, 39.916527]\n  }\n}'
    };

    // 格式切换
    var formatTabs = document.querySelectorAll('.format-tab');
    formatTabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        currentFormat = this.dataset.format;
        formatTabs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // 更新占位符
        if (currentFormat === 'lnglat') {
          leftInput.placeholder = '示例：\n[{lng: 116.397, lat: 39.916}, {lng: 121.473, lat: 31.230}]\n或\n[[116.397, 39.916], [121.473, 31.230]]\n或\n116.397,39.916;121.473,31.230';
          rightInput.placeholder = '转换结果将显示在这里...';
        } else if (currentFormat === 'wkt') {
          leftInput.placeholder = '示例：\nPOINT(116.397128 39.916527)\nLINESTRING(116.397128 39.916527, 121.473701 31.230416)';
          rightInput.placeholder = '转换结果将显示在这里...';
        } else if (currentFormat === 'geojson') {
          leftInput.placeholder = '示例：\n{\n  "type": "Feature",\n  "geometry": {\n    "type": "Point",\n    "coordinates": [116.397128, 39.916527]\n  }\n}';
          rightInput.placeholder = '转换结果将显示在这里...';
        }
      });
    });

    // 解析 lnglat 数组
    function parseLngLatArray(input) {
      try {
        // 尝试解析 JSON 格式
        var parsed = JSON.parse(input);
        if (Array.isArray(parsed)) {
          if (parsed.length === 0) return [];
          
          // 检查是对象数组还是坐标数组
          if (typeof parsed[0] === 'object' && parsed[0].lng !== undefined) {
            // 对象数组格式 [{lng: x, lat: y}, ...]
            return parsed.map(function(item) {
              return [parseFloat(item.lng), parseFloat(item.lat)];
            });
          } else if (Array.isArray(parsed[0])) {
            // 坐标数组格式 [[x, y], ...]
            return parsed.map(function(coord) {
              return [parseFloat(coord[0]), parseFloat(coord[1])];
            });
          }
        }
      } catch (e) {
        // 不是 JSON，尝试其他格式
      }
      
      // 尝试解析字符串格式
      var lines = input.split(/[;\n]/);
      var coords = [];
      
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;
        
        var parts = line.split(/[,\s]+/);
        if (parts.length >= 2) {
          var lng = parseFloat(parts[0]);
          var lat = parseFloat(parts[1]);
          if (!isNaN(lng) && !isNaN(lat)) {
            coords.push([lng, lat]);
          }
        }
      }
      
      return coords;
    }

    // 生成 lnglat 数组
    function generateLngLatArray(coords, format) {
      if (format === 'object') {
        return JSON.stringify(coords.map(function(coord) {
          return {lng: coord[0], lat: coord[1]};
        }), null, 2);
      } else if (format === 'array') {
        return JSON.stringify(coords, null, 2);
      } else if (format === 'string') {
        return coords.map(function(coord) {
          return coord[0] + ',' + coord[1];
        }).join(';');
      }
      return JSON.stringify(coords);
    }

    // WKT 解析和生成
    function parseWKT(wkt) {
      try {
        var parts = wkt.match(/^(\w+)\s*\((.*)\)$/);
        if (!parts) return null;
        
        var type = parts[1].toUpperCase();
        var coords = parts[2];
        
        if (type === 'POINT') {
          var point = coords.trim().split(/\s+/);
          return [[parseFloat(point[0]), parseFloat(point[1])]];
        } else if (type === 'LINESTRING') {
          var points = coords.split(',').map(function(p) {
            var xy = p.trim().split(/\s+/);
            return [parseFloat(xy[0]), parseFloat(xy[1])];
          });
          return points;
        } else if (type === 'POLYGON') {
          var rings = coords.split('),(').map(function(ring) {
            ring = ring.replace(/[()]/g, '');
            var points = ring.split(',').map(function(p) {
              var xy = p.trim().split(/\s+/);
              return [parseFloat(xy[0]), parseFloat(xy[1])];
            });
            return points;
          });
          return rings[0]; // 返回外环
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    function generateWKT(coords) {
      if (coords.length === 1) {
        return 'POINT(' + coords[0][0] + ' ' + coords[0][1] + ')';
      } else if (coords.length > 1) {
        var coordsStr = coords.map(function(p) {
          return p[0] + ' ' + p[1];
        }).join(', ');
        return 'LINESTRING(' + coordsStr + ')';
      }
      return '';
    }

    // GeoJSON 解析和生成
    function parseGeoJSON(geojson) {
      try {
        var parsed = JSON.parse(geojson);
        var coords = [];
        
        if (parsed.type === 'Feature') {
          coords = extractCoordinates(parsed.geometry);
        } else if (parsed.type === 'FeatureCollection') {
          if (parsed.features.length > 0) {
            coords = extractCoordinates(parsed.features[0].geometry);
          }
        } else if (parsed.type) {
          coords = extractCoordinates(parsed);
        }
        
        return coords;
      } catch (e) {
        return null;
      }
    }

    function extractCoordinates(geometry) {
      if (geometry.type === 'Point') {
        return [geometry.coordinates];
      } else if (geometry.type === 'LineString') {
        return geometry.coordinates;
      } else if (geometry.type === 'Polygon') {
        return geometry.coordinates[0]; // 返回外环
      }
      return [];
    }

    function generateGeoJSON(coords) {
      if (coords.length === 1) {
        return JSON.stringify({
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: coords[0]
          }
        }, null, 2);
      } else if (coords.length > 1) {
        return JSON.stringify({
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: coords
          }
        }, null, 2);
      }
      return '';
    }

    // 文本清理函数
    function cleanInputText(input) {
      return input
        .replace(/\r\n/g, '\n')  // 统一换行符
        .replace(/\r/g, '\n')    // 处理回车符
        .replace(/\n\s+/g, '\n') // 移除行首空格
        .replace(/\s+\n/g, '\n') // 移除行尾空格
        .replace(/\n{3,}/g, '\n\n') // 最多保留两个连续换行
        .trim(); // 移除首尾空白
    }

    // 转换函数
    function convertData(input, fromFormat, toFormat) {
      // 清理输入文本
      var cleanedInput = cleanInputText(input);
      
      if (!cleanedInput) {
        showStatus('请输入要转换的数据', 'error');
        return '';
      }

      try {
        var coords = null;
        
        // 解析输入格式
        if (fromFormat === 'lnglat') {
          coords = parseLngLatArray(cleanedInput);
        } else if (fromFormat === 'wkt') {
          coords = parseWKT(cleanedInput);
        } else if (fromFormat === 'geojson') {
          coords = parseGeoJSON(cleanedInput);
        }
        
        if (!coords || coords.length === 0) {
          showStatus('无法解析输入数据，请检查格式是否正确', 'error');
          return '';
        }
        
        // 生成输出格式
        var result = '';
        if (toFormat === 'lnglat') {
          result = generateLngLatArray(coords, 'object');
        } else if (toFormat === 'wkt') {
          result = generateWKT(coords);
        } else if (toFormat === 'geojson') {
          result = generateGeoJSON(coords);
        }
        
        showStatus('转换完成！共处理 ' + coords.length + ' 个坐标点', 'success');
        return result;
        
      } catch (e) {
        showStatus('转换失败：' + e.message, 'error');
        return '';
      }
    }

    function showStatus(message, type) {
      status.className = 'status ' + type;
      status.innerHTML = '<div>' + message + '</div>';
    }

    function copyText(text) {
      if (text) {
        navigator.clipboard.writeText(text).then(function() {
          showStatus('已复制到剪贴板', 'success');
        }).catch(function() {
          showStatus('复制失败，请手动选择复制', 'error');
        });
      }
    }

    function loadSampleData(target) {
      target.value = sampleData[currentFormat];
      showStatus('已加载示例数据', 'info');
    }

    // 事件绑定
    $('left-to-right').addEventListener('click', function() {
      var result = convertData(leftInput.value, currentFormat, 'geojson');
      if (result) rightInput.value = result;
    });

    $('right-to-left').addEventListener('click', function() {
      var result = convertData(rightInput.value, 'geojson', currentFormat);
      if (result) leftInput.value = result;
    });

    $('clear-left').addEventListener('click', function() {
      leftInput.value = '';
    });

    $('clear-right').addEventListener('click', function() {
      rightInput.value = '';
    });

    $('copy-left').addEventListener('click', function() {
      copyText(leftInput.value);
    });

    $('copy-right').addEventListener('click', function() {
      copyText(rightInput.value);
    });

    $('sample-left').addEventListener('click', function() {
      loadSampleData(leftInput);
    });

    $('sample-right').addEventListener('click', function() {
      loadSampleData(rightInput);
    });

    // 初始化
    showStatus('等待转换...', 'info');
  })();
  </script>
</body>
</html>
